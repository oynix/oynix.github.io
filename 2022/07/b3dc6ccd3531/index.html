<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/p.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/p.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/p.png">
  <link rel="mask-icon" href="/images/p.png" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"oynix.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gittabl","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="API Gateway接收请求，继而传递给Lambda处理。">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS Lambda + API Gateway 搭建全流程">
<meta property="og:url" content="https://oynix.com/2022/07/b3dc6ccd3531/index.html">
<meta property="og:site_name" content="oynix">
<meta property="og:description" content="API Gateway接收请求，继而传递给Lambda处理。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-16T03:29:37.000Z">
<meta property="article:modified_time" content="2022-07-16T03:29:37.000Z">
<meta property="article:author" content="oynix">
<meta property="article:tag" content="AWS">
<meta property="article:tag" content="Lambda">
<meta property="article:tag" content="API Gateway">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://oynix.com/2022/07/b3dc6ccd3531/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>AWS Lambda + API Gateway 搭建全流程 | oynix</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDBNTK34GB"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDBNTK34GB');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="oynix" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">oynix</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">于无声处听惊雷，于无色处见繁花</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">119</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">33</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">173</span></a>

  </li>
        <li class="menu-item menu-item-message">

    <a href="/message/" rel="section"><i class="fas fa-envelope-open-text fa-fw"></i>留言板</a>

  </li>
        <li class="menu-item menu-item-articles">

    <a href="/articles/" rel="section"><i class="fa fa-blog fa-fw"></i>技术博客</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL295bml4" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://oynix.com/2022/07/b3dc6ccd3531/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/p.png">
      <meta itemprop="name" content="oynix">
      <meta itemprop="description" content="避免没有计划的行动">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="oynix">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          AWS Lambda + API Gateway 搭建全流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 11:29:37" itemprop="dateCreated datePublished" datetime="2022-07-16T11:29:37+08:00">2022-07-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AWS/" itemprop="url" rel="index"><span itemprop="name">AWS</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>API Gateway接收请求，继而传递给Lambda处理。</p>
<span id="more"></span>

<h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h3><p>发展至今，AWS已然成为一头庞然大物，集成并提供着几千个服务，即便只是一个小需求，也很难只用其中的一种服务，而是多种组合来满足。这篇文简单说说通过AWS的Lambda和API Gateway作为主框架，来搭建一个无服务架构。</p>
<p>之所以会有眼花缭乱的服务，我想，应该是为了满足各种生产需求。拿车来举个例子，假如一台30万的车，买下来可以开10年，平均一年3万，如果租的话，一天大概300。很容易可以算出：当一年当中有用车需求的天数达到100天时，租车和买车的成本是一样的，少于100天时，租车更划算，反之则买车更划算。一家原本只提供卖车服务的公司，为了满足用车天数少的用户，也是为了赚更多的钱，便增加了一项租车服务，就这样，业务线从一条增加到了两条，随着用户需求的增加，业务线会越来越多。所以，服务种类的增加，根源上都是为了满足不同的需求，我想AWS应如是。</p>
<p>回到正题。</p>
<p>Lambda是AWS提供的一种FaaS(Function as a Service)服务，是继IaaS(Infrastructure)、PaaS(Platform)、SaaS(Software)和BaaS(Backend)之后的新服务，用户只需要关心业务逻辑的实现，其他的均交给Lambda来做，省去了配置云设施、监控、集群等步骤，用完付费就可以了。本打算用钱换时间，但实际上，时间成本并不会减少，因为省下来的时间都用来学习使用这些服务，甚至可能还不太够。</p>
<p>而API Gateway，正如名字所言，是一个网关，用来接收请求，并转发。它的功能就是这样，具体怎么使用要看用户怎么给它定位。Lambda其实是支持直接请求的，每个Lambda都可生成一个唯一的URL，对于客户端来说，这个URL就是服务器的地址，可以向这个地址发送网络请求，Lambda收到请求后，就会把请求的数据交给里面的逻辑代码处理。但是，普遍性而言，都不会暴露Lambda的URL，而是中间通过API Gateway来接收，再转发到Lambda。因为API Gateway是个独立的服务，并不是和Lambda绑定，它收到请求后，可以转发给Lambda，也可以转发给其他服务，还可以转发给不同的Lambda。Gateway的存在，极大的增加了服务器的灵活性。</p>
<h3 id="2-Lambda编写和部署"><a href="#2-Lambda编写和部署" class="headerlink" title="2. Lambda编写和部署"></a>2. Lambda编写和部署</h3><p>现在Lambda支持了7种语言的支持，如Java、Python、Go、Node.js等，但流程都是类似的，提供一个入口函数，Lambda收到请求时，就会调用这个方法，请求相关的数据会以参数的形式传递给函数，而我们需要做的就是编写处理这些数据的逻辑代码，然后再将处理结果通过函数的返回值传递给Lambda，这样，一次调用流程就走完了。</p>
<p>计费方式，则是这个过程中所使用的资源，比如CPU时长、占用内存大小、占用本地存储的大小，传递数据的大小，等多个维度，用了多少就付多少的钱。每个月会送个几百万次，所以单独看一次正常的调用，可能花一分钱都不到，约等于免费。但是，是真的免费吗？一个2万的包，假设可以背2年，一天27块钱，平均一分钟一分多钱，是不是也可以约等于不花钱。</p>
<p>至于部署，则有多种方式，本质上也都是一样的，即，把可执行的代码上传到Lambda，以便于Lambda可以调用。可以在网页上上传zip压缩包，也可以将zip上传到S3，再从S3上传到Lambda，也可以通过AWS CLI命令行，或者其他三方工具，等等。我用的serverless，<span class="exturl" data-url="aHR0cHM6Ly93d3cuc2VydmVybGVzcy5jb20v">官网地址<i class="fa fa-external-link-alt"></i></span>，它本身和AWS的Lambda好像是同等定位的，也是卖FaaS服务的，我没细看，只用了它提供的命令行，先写配置文件，然后通过serverless命令就可以一键部署了。这里要注意一下版本，最新版3xx竟然和Tencent跳到一条船上了，用起来很多限制，束手束脚的，如果介意，安装旧版本即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g serverless@2.72.2</span><br></pre></td></tr></table></figure>

<p>我选用的Go，配置文件名为<code>serverless.yml</code>，其中，有这么几个选项是必须的，具体写了简短解释，除此之外，还有很多可以配置的选项，比如使用的资源，触发的条件，执行的角色，数量多到吓人，如有需要，可以去文档里直接搜索，然后按照格式配置即可，<span class="exturl" data-url="aHR0cHM6Ly93d3cuc2VydmVybGVzcy5jb20vZnJhbWV3b3JrL2RvY3MvcHJvdmlkZXJzL2F3cy9ndWlkZS9zZXJ2ZXJsZXNzLnltbA==">这里是文档地址<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service:</span> <span class="string">sample-lambda</span></span><br><span class="line"><span class="attr">frameworkVersion:</span> <span class="string">&#x27;2&#x27;</span> <span class="comment"># version of serverless</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># provider</span></span><br><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aws</span> <span class="comment"># </span></span><br><span class="line">  <span class="attr">runtime:</span> <span class="string">go1.x</span> <span class="comment"># lambda将在runtime配置的环境中执行我们上传的代码，</span></span><br><span class="line">  <span class="attr">lambdaHashingVersion:</span> <span class="number">20201221</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">$&#123;opt:stage,</span> <span class="string">&#x27;dev&#x27;</span><span class="string">&#125;</span> <span class="comment"># 表示从serverless命令中读取名字为stage的参数，如果没指定则使用缺省值dev</span></span><br><span class="line">  <span class="attr">region:</span> <span class="string">ap-south-1</span> <span class="comment"># 部署的区域</span></span><br><span class="line">  <span class="attr">profile:</span> <span class="string">$&#123;self:custom.profile.$&#123;self:provider.stage&#125;&#125;</span> <span class="comment"># 操作aws账户就需要权限，profile指定的就是认证信息，可通过aws configure命令配置</span></span><br><span class="line">  <span class="attr">architecture:</span> <span class="string">x86_64</span> <span class="comment"># unsupported arm64 for go1.x # 指令集</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定需要将哪些内容打成zip压缩包</span></span><br><span class="line"><span class="attr">package:</span></span><br><span class="line">  <span class="attr">patterns:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;!./**&#x27;</span> <span class="comment"># 当前目录下所有文件夹都不需要</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./bin/**</span> <span class="comment"># 只需要bin目录下，我把编译生成的可执行文件放在了这里</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义的一些参数</span></span><br><span class="line"><span class="attr">custom:</span></span><br><span class="line">  <span class="attr">version:</span></span><br><span class="line">    <span class="attr">dev:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">prod:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">profile:</span></span><br><span class="line">    <span class="attr">dev:</span> <span class="string">profiledev</span></span><br><span class="line">    <span class="attr">prod:</span> <span class="string">profileprod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># function是Lambda中的调用单位，Lambda每次调用一个fuction，也就是函数，来处理收到的请求。可以部署多个function。</span></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">app:</span> <span class="comment"># 这里只部署了一个叫做app的function，它最终的名字是：&#123;server_name&#125;-&#123;stage&#125;-&#123;function_name&#125;</span></span><br><span class="line">    <span class="attr">handler:</span> <span class="string">bin/app</span>  <span class="comment"># executable file contains main function</span></span><br><span class="line">    <span class="attr">memorySize:</span> <span class="number">128</span>  <span class="comment"># MB 执行是分配的内存</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">60</span>  <span class="comment"># sec 超时时间，如果60秒后还不给lambda返回结果，那么lambda就会给请求者一个超时回应</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="comment"># 环境变量，可在代码中使用</span></span><br><span class="line">      <span class="attr">Version:</span> <span class="string">$&#123;self:custom.version.$&#123;self:provider.stage&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>部署时，只用这么一条命令即可，注意要在配置文件<code>serverless.yml</code>目录下执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serverless deploy --stage dev</span><br></pre></td></tr></table></figure>

<p>每次来了新请求时，如果没有正在跑着的虚拟机，Lambda会启动一个新的虚拟机，来执行操作，很显然，启动并配置虚拟机是需要时间的，虽然很短，毫秒级别，但如果为了追求极致的体验，可以使用预配置并发，顾名思义，提前给你启动并配置好一定数量的机器，请求一旦来了便直接处理。既然有机器在跑，那肯定是要收费的了。就像冬天想要开车，需要热个一两分钟再跑，如果你不想等这一两分钟，那就要保证车是提前热的，也就是一直没有熄火，既然没熄火那自然是要烧油的了。</p>
<p>此外，如果要删除Lambda，一定要把相关联的CloudFormation和S3中对应的存储桶删掉，这样才算完整删除。其中，CloudFormation负责把S3中的代码部署到Lambda。</p>
<h3 id="3-附加：压缩可执行文件"><a href="#3-附加：压缩可执行文件" class="headerlink" title="3. 附加：压缩可执行文件"></a>3. 附加：压缩可执行文件</h3><p>go build后出来的可执行文件很大，是可以通过压缩来减小大小，来提高传输效率。如果你坚定的选择不压缩，似乎也没什么问题。</p>
<p>go build默认是用静态编译，即编译后的文件中包含执行中所有需要的库，所以，即便调用了一个库里的一个函数，那么也会把这个库完整的打包进可执行文件里，有时发现只加了几行代码，但是编译后的文件却一下大了很多，原因便在此。</p>
<p>除了静态编译，还可以动态编译，也就是说，不把所有的依赖库都打进可执行文件里，对于一些常见的系统库，选择在执行时动态链接的方式，这样一来可以大大减少可执行文件的体积。但是，有得便有失，如果执行的环境中没有需要的库，那么便无法正确执行。</p>
<p>我选用的方式是，静态编译，在生成的可执行文件基础上，再进一步压缩。动态编译体积能减少很夸张，有时能达到90%以上，而upx最好也就70%的样子。相比于极致，我更追求可靠。此外，在build时加上trimpath和ldflags可以进一步减小体积，虽然有限，但苍蝇腿也是肉不是。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GOOS=linux CGO_ENABLED=0 go build -trimpath -ldflags &quot;-s -w&quot; -o bin/app_origin cmd/app.go</span><br><span class="line"></span><br><span class="line">upx -9 bin/app_origin -o bin/app</span><br></pre></td></tr></table></figure>

<h3 id="4-附加：角色和策略"><a href="#4-附加：角色和策略" class="headerlink" title="4. 附加：角色和策略"></a>4. 附加：角色和策略</h3><p>在AWS世界设定里，操作是需要一个角色来执行的。比如，你想执行Lambda，那么你就需要为这个操作指定一个角色，让这个角色来执行。打个比方，你想打开一个楼里面的102号房间，那么你就需要指派一个人，去找到102号并打开，这里的这个人，就对应AWS里的角色概念。那么什么是策略呢？策略就是为这个角色附加的权限，接着刚才那个例子，你指派完这个人之后，还需要给他102号房间的钥匙，这样等他到了102号房门口，才能用钥匙打开门。这里的钥匙，就是策略。</p>
<p>所以，我们要执行Lambda，就要先创建一个角色，然后再创建一个策略，为这个策略添加可以执行Lambda的权限，接着把策略赋予给角色，最后把角色指派给我们创建的Lambda。如果该角色没有执行Lambda的权限，那么在执行的时候就会报错。</p>
<p>AWS中所有的操作都有对应的权限。在创建一个策略时，需要给这个策略指定4个参数：服务、操作、资源和请求条件。服务，就是AWS中所有提供的功能；操作，这里的操作分的很细致，比如列表、读取、写入等等；资源，指的是该服务下的所有资源，可以指定具体到某一个，也可以某一范围；而请求条件，则是对调用者身份的验证。</p>
<p>举个例子，我想查看S3中名字叫Upload的桶里的avatar.png（S3是AWS的一款云存储的服务，可以简单理解成网络云盘），如果给这个操作创建一个策略的话，那么服务便是S3，操作是读取Get，资源是Upload/avatar.png，不加额外的请求条件，然后把这三个组合在一起，就是一个策略，附加了这个策略的角色，就可以执行查看avatar.png的操作了。</p>
<p>对于其他的行为，都是一样的道理。AWS中对操作和资源划分的粒度极小，基本不可再分割，所以可以搭配出各种权限策略。当然，一个角色可以同时附加多个策略，意味着它可以执行多个操作，创建策略的基本理念就是，只赋予必要的权限，避免过宽的权限带来的不必要问题。</p>
<h3 id="5-API-Gateway"><a href="#5-API-Gateway" class="headerlink" title="5. API Gateway"></a>5. API Gateway</h3><p>API Gateway可以用来接收客户端请求，但它不做处理，而是将请求转发出去，交给别人去处理，等拿到别人返回的处理结果后，再把结果返回给客户端，这样就完成了一次网络调用。虽然直观上看这个操作很像是转发，但在API Gateway里，它不叫转发，而是叫做集成，integration。这只是一个粗糙的介绍，而实际上这里面还有诸多细节。它有多种，比如websocket类型的，http类型的，REST类型的，这里只说REST类型。</p>
<p>在使用REST API Gateway时，要先创建资源，比如students，然后再在这个资源上添加请求方法，比如GET，一般用来表示获取，然后再把这个方法集成到Lambda，接着还要部署，部署时要指定一个阶段stage，比如叫做dev，成功后会生成一个URL，这个时候，客户端就可以发起请求，来获取所有的学生</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Method URL/&#123;stage&#125;/&#123;resource&#125;</span><br><span class="line"></span><br><span class="line">GET URL/dev/students</span><br></pre></td></tr></table></figure>
<p>对于URL，可以配制成固定的域名，如果没有这样的需求，可以使用AWS提供的缺省URL，它的一般格式是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://&#123;api_gateway_id&#125;.execute-api.&#123;region_name&#125;.amazonaws.com</span><br></pre></td></tr></table></figure>

<p>API Gateway从客户端那里接收到的请求，叫做方法请求，把转发请求包装一下，这时叫做集成请求，然后转发给处理者，等从处理者那收到响应，这个响应叫做集成响应，再包装一下，这时候叫做方法响应，最后把方法响应返回给客户端。这个过程中，一共出现了4个变量：方法请求、集成请求、集成响应和方法响应。在每一个变量上面，都可以做一些操作。</p>
<p>要敏感的记住这4个变量，因为下面的所有操作都是基于它们的，会频繁提到，最好可以一提到名字就能反应过来在说谁。</p>
<p>比如数据转换，客户端发来的数据Lambda不能处理，则需要在集成请求中转换一下，然后再发送给Lambda。或者Lambda返回的数据不是客户端想要的格式，那么需要在集成响应中做转换后再返给客户端。</p>
<p>此外，可以在方法请求上添加请求验证，如何客户端验证不通过，则直接返回，后面的流程不会再走，减少无效的调用，毕竟每次调用Lambda都是要花钱的，能省则省。</p>
<h3 id="6-API-Gateway转发至Lambda"><a href="#6-API-Gateway转发至Lambda" class="headerlink" title="6. API Gateway转发至Lambda"></a>6. API Gateway转发至Lambda</h3><p>从Gateway过去的数据，实际上就是一个JSON串，这里面有请求的Resource，请求的Method，请求的Header，请求的Body等相关的所有数据。这个时候可以使用Lambda代理集成，它会把客户端发来的所有数据，原封不动的发给Lambda，Lambda根据Resource判断客户端请求的是哪个资源，根据Method判断请求方式，根据Header、PathParameter，QueryParameter来作出相应的逻辑处理，最终返回结果数据，这和处理Http请求本质上是一样的。</p>
<p>Gateway发给Lambda的数据是一个JSON串，但是不同的集成配置，里面的字段是不一样的，所以要用不同的结构体来接收。当使用Lambda代理集成时，数据结构是下面这样的，Request中的数据包括了所有Http相关的字段，而Response中的字段也是和Http响应结构中的数据一一对应</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/aws/aws-lambda-go/lambda&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/aws/aws-lambda-go/lambdacontext&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/aws/aws-lambda-go/events&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  lambda.Start(handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handler</span><span class="params">(ctx context.Context, event events.APIGatewayProxyRequest)</span> <span class="params">(response events.APIGatewayProxyResponse, err error)</span></span> &#123;</span><br><span class="line">  lctx, _ := lambdacontext.FromContext(ctx)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// logic handle</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> response, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> APIGatewayProxyRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">  Resource                        <span class="keyword">string</span>                        <span class="string">`json:&quot;resource&quot;`</span> <span class="comment">// The resource path defined in API Gateway</span></span><br><span class="line">  Path                            <span class="keyword">string</span>                        <span class="string">`json:&quot;path&quot;`</span>     <span class="comment">// The url path for the caller</span></span><br><span class="line">  HTTPMethod                      <span class="keyword">string</span>                        <span class="string">`json:&quot;httpMethod&quot;`</span></span><br><span class="line">  Headers                         <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>             <span class="string">`json:&quot;headers&quot;`</span></span><br><span class="line">  MultiValueHeaders               <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>           <span class="string">`json:&quot;multiValueHeaders&quot;`</span></span><br><span class="line">  QueryStringParameters           <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>             <span class="string">`json:&quot;queryStringParameters&quot;`</span></span><br><span class="line">  MultiValueQueryStringParameters <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>           <span class="string">`json:&quot;multiValueQueryStringParameters&quot;`</span></span><br><span class="line">  PathParameters                  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>             <span class="string">`json:&quot;pathParameters&quot;`</span></span><br><span class="line">  StageVariables                  <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>             <span class="string">`json:&quot;stageVariables&quot;`</span></span><br><span class="line">  RequestContext                  APIGatewayProxyRequestContext <span class="string">`json:&quot;requestContext&quot;`</span></span><br><span class="line">  Body                            <span class="keyword">string</span>                        <span class="string">`json:&quot;body&quot;`</span></span><br><span class="line">  IsBase64Encoded                 <span class="keyword">bool</span>                          <span class="string">`json:&quot;isBase64Encoded,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> APIGatewayProxyResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">  StatusCode        <span class="keyword">int</span>                 <span class="string">`json:&quot;statusCode&quot;`</span></span><br><span class="line">  Headers           <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>   <span class="string">`json:&quot;headers&quot;`</span></span><br><span class="line">  MultiValueHeaders <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span> <span class="string">`json:&quot;multiValueHeaders&quot;`</span></span><br><span class="line">  Body              <span class="keyword">string</span>              <span class="string">`json:&quot;body&quot;`</span></span><br><span class="line">  IsBase64Encoded   <span class="keyword">bool</span>                <span class="string">`json:&quot;isBase64Encoded,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-API-Gateway转发至S3"><a href="#7-API-Gateway转发至S3" class="headerlink" title="7. API Gateway转发至S3"></a>7. API Gateway转发至S3</h3><p>我这里还有个需求，就是上传文件，那首选肯定是S3了，那Gateway收到请求后，可以直接将请求转发至S3，而不需要多次转手，这个时候就凸出了Gateway的灵活性。在配置集成请求时，就不能再选Lambda了，而是选AWS服务，在其中找到S3即可。</p>
<p>S3是根据URL来操作对应的资源的，而客户端发来的请求是API中定义的资源，所以这其中就需要转换路径，将客户端的请求URL转换成操作S3中资源的URL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://s3.&#123;region_name&#125;.amazonaws.com/&#123;bucket_name&#125;/&#123;file_name&#125;</span><br></pre></td></tr></table></figure>
<p>S3的Path是由存储桶的名字和资源名字组合而成，在集成请求中覆盖路径时，就要填上对应的参数，可以在集成请求中定义变量，用变量来指定方法请求中的值，比如方法请求的URL是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL/dev/&#123;dir&#125;/&#123;file_name&#125;</span><br></pre></td></tr></table></figure>
<p>dir指定目录，file_name指定文件名，让客户端来决定想要向哪个目录上传什么文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL/dev/avatar/tom.png</span><br></pre></td></tr></table></figure>
<p>这个请求表示向avatar目录上传一张叫tom.png的图片，对应的业务需求可能就是一个叫tom的用户更新了自己的头像。那么Gateway就可以在集成请求中定义两个变量：bucket_name和file_name，分别映射方法请求中的dir和file_name，用{bucket_name}/{file_name}来覆盖掉原Path，然后发送给S3就可以了。</p>
<p>注意，在集成请求中想要使用方法请求中的参数，比如Query参数、Path参数或者Header参数，方式就是在集成请求中定义变量，然后将变量映射到方法请求中的参数，这样通过变量就可以拿到方法请求中的参数值了。</p>
<p>上传成功时，S3返回的响应是没有Body的，但是我想把上传文件的下载路径返回给客户端，也就是我希望方法响应的Body里是文件下载路径，这个时候就需要在集成响应中做数据转换了，把原Body（空）转换成目标格式：<code>&#123;&quot;link&quot;:&quot;https://xxxxxxxxx&quot;&#125;</code>，这里面要用到Apache的VOLICITY语言，照着文档编写，不算太难。</p>
<h3 id="8-API-Gateway授权方配置"><a href="#8-API-Gateway授权方配置" class="headerlink" title="8. API Gateway授权方配置"></a>8. API Gateway授权方配置</h3><p>上面提到，在方法请求中可以添加授权的验证，来限制客户端的请求，而这个请求我便是加在了上传文件的方法请求上，因为并不是谁都可以上传文件，只有登录后的用户才可以，原因很简单，因为S3存储文件也是收费的，一切为了省钱。</p>
<p>授权有两种类型，一个是IAM，一个是授权方，这里说一说授权方。授权方的工作流程是这样的，Gateway收到客户端的请求后，将请求中的关键数据发给授权方，授权方会返回一个结果，Gateway根据返回的结果来判定客户端是否具有访问的权限。这就像伤残鉴定，我撞到了你，你说你受伤了，想要100万赔偿，结果去医院一鉴定，医生说你是装的，别说100万了，连100块都没有。</p>
<p>所以，要想增加权限的判定，就要先创建一个授权方。</p>
<p>授权方有两种类型，一种是Cognito，这个是AWS提供的一种服务，收费的。另一种是Lambda，也是收费的。既然都要花钱，那相比Cognito这个陌生的面孔，我更愿意使用Lambda这个老伙计。Cognito的流程大概是这样子的，它需要用户先行登录，不管是通过第三方登录，比如Facebook、Google，还是自己的登录功能，这些都可以，登录成功之后要获取一个和用户相关的ID，再用这个ID去Cognito那里去换一个Token，这个Token就是通行证了，用这个Token就可以通过Cognito的验证。</p>
<p>如果是用Lambda，那么Gateway在收到客户端请求后，会将请求Header中的Authorization拿出来，发送给Lambda，Lambda中则需要判断这个Authorization是否合法，然后将结果返回即可。</p>
<h3 id="9-SES"><a href="#9-SES" class="headerlink" title="9. SES"></a>9. SES</h3><p>我这里还有个发邮件的需求，所以还用到了AWS的SES服务，Simple Email Service，只要你能想到的需求，AWS都有与之对应的一个或者多个服务卖给你，这句话说的果然没错。发送邮件时，直接调用官方提供的SDK即可。既然想发邮件，那么就需要有这个操作的权限，上面说到过，权限是怎么来的呢？是根据执行角色身上所挂着的所有策略来的，因此，要给执行Lambda的角色加一个发送SES的策略，可以单独加策略，也可以直接在原策略上增加权限。</p>
<p>SES有两种模式，一种叫domain，一种叫email，对于收邮件的人来说，这两种的区别就在于收件人的地址。domain需要给SES配置一个自己的域名，要提前买好且确保可用，收件人看到的发件人地址就是配置的域名了，如果没有域名，就要用email模式了，这个时候收件人看到的发件人地址长到可以从这排到法国，像这样</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">01090181be5c4cf3-6ccb1da1-5068-4759-92e4-17b467f5cf7e-000000@ap-south-1.amazonses.com</span><br></pre></td></tr></table></figure>

<p>没错，我用的就是这用，抛开其他原因不谈，最主要的还是因为我没有域名。配置email模式时，AWS需要你提供一个发件人的邮箱，意思就是，虽然地址是上面这一长串，但是发件人的名字却是你提供的这个邮箱的名字。假如，我提供的是<code>ohmyladygg@gmail.com</code>，然后收件人看到的发件人地址就是上面那一长串，发件人名称是<code>ohmyladygg</code>。</p>
<p>光提供邮箱还不够，AWS还要验证一下，确保这个邮箱真实有效，并且属于你。方式就是向这个邮箱里发个链接，只要在24小时之内点开，那么就算验证通过了，简单的很。</p>
<p>此外，默认的SES是处于沙盒状态的，什么是沙盒状态呢？其实就是比正常状态多了几个限制，比如每24小时内只能发送200封邮件，比如只能发送给验证过的邮箱，没错，这也就是说，只能用验证过的邮箱，再发送给验证过的邮箱，自己和自己玩。如果想要解除沙盒状态，那么需要提供一些资料，然后发申请，有点麻烦。</p>
<h3 id="10-RDS"><a href="#10-RDS" class="headerlink" title="10. RDS"></a>10. RDS</h3><p>关系型数据库，Relation Database Service，看吧，只要想买，AWS就有的卖。有多种可供选择，比如MySql、Oracle、Aurora等等。我常用的就是MySql，其中的Aurora就是Amazon在MySql基础之上，做了一些处理，优点就是相比于MySql性能更好一些，缺点就是更贵，当然，这不是它的缺点，而是我的缺点。当数据量特别大，需求特别高时，Aurora确实可以提供更好的服务，更佳的表现，若要平时开发，MySql表示可以再战个几年不是问题</p>
<h3 id="11-VPC和子网"><a href="#11-VPC和子网" class="headerlink" title="11. VPC和子网"></a>11. VPC和子网</h3><p>如果你真的把上面这些操作了一遍，你会发现到处都能看到VPC这个东西，它的全称是Virtual Private Cloud，虚拟私有云，是以地区为单位的账号隔离。乍一听可能听不懂，不像是人话，上比喻大法。</p>
<p>先说地区。AWS在全球多个地区都有机房，比如，美国西部有两个，加利福尼亚（us-west-1）和俄亥俄（us-west-2），亚太东部有一个，香港（ap-east-1），亚太南部有一个，孟买（ap-south-1），等等，有很多。只要你创建了账号，那么就会在每个地区给你创建一个VPC，这个VPC默认是隔离的，别人无法访问，就好比在里面单独建了一个房间给你，开启一台EC2机器实例后，将其放到这个房间里，那么它就是绝对安全的，因为外界访问不到。</p>
<p>再说子网。在一个地区，其实不仅仅有一个机房，至少要有两个，这样做不是因为AWS有钱，而是为了容灾，尤其是日本，动不动就地震，可能一个纵波过去，房子就没了，那机房自然也无法幸免于难，一个地区建立多个机房就是为了应对这种情况。机房选址也是有要求的，不能离的太近，也不能离的太远，机房之间用高速线路连接，延迟极低。一个地区有一个VPC，那么一个机房就对应一个子网，比如孟买，可以看到默认有三个子网，ap-south-1a、ap-south-1b和ap-south-1c，这就表明在孟买有三个机房。既然都同属于一个VPC下，那么子网之间是可以通信的，就好比虽然我们位于不同的角落，但既然在同个房间里，那么我们就可以聊天。</p>
<p>这些都是默认的情况，除此之外，我们还可以手动建立更多的VPC和子网，来满足各种需求。</p>
<h3 id="12-安全组和网络ACL"><a href="#12-安全组和网络ACL" class="headerlink" title="12. 安全组和网络ACL"></a>12. 安全组和网络ACL</h3><p>上面说到，默认情况下VPC是隔离的，也就是说这个房间是没有门的，外面的人进不来，里面的人也出不去，安全是安全了，但世界那么大，终归是有人想出去看看的，这个时候就需要给房间装个门，这个门就是互联网网关，还有其他种类的门，但这里只说说这种。</p>
<p>既然装了门，那么就有了进出的可能，为了安全，所以还要控制谁能进来，谁能出去，这件事，归安全组和网络ACL负责，进来的叫做入站流量，出去的叫做出站流量。它们两个很像，都是通过配置入站规则和出站规则来控制流量。</p>
<p>但还是有些区别的，不然也就不会二者都存在。网络ACL是在子网级别运行，而安全组则是在实例级别运行，就像是防火墙一般，这是最大的区别。其他的就不多说了，<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL3poX2NuL3ZwYy9sYXRlc3QvdXNlcmd1aWRlL1ZQQ19TZWN1cml0eS5odG1sI1ZQQ19TZWN1cml0eV9Db21wYXJpc29u">这里是官网的详细说明<i class="fa fa-external-link-alt"></i></span></p>
<p>额外多一句安全组的源/目标，源就是进站流量的IP地址，目标就是出站流量的IP地址，支持v4和v6。可以限定精确的IP地址，也可以限制范围的IP地址，用CIDR表示，如203.0.113.0/24，还可以使用前缀，这个我没用过。最后还有一种，就是指定安全组，什么意思呢，就是可以把IP限定为使用同一个安全组的实例，比如把源设定为sg-002，那么来自这个安全组的所有流量，都在这个设定范围内，这也是缺省的设置。这个有点儿不同与防火墙的概念了，原本安全组的使用定位就很接近于防火墙，但是又可以使用安全组来过滤IP。</p>
<h3 id="13-本地连接RDS"><a href="#13-本地连接RDS" class="headerlink" title="13. 本地连接RDS"></a>13. 本地连接RDS</h3><p>上面说完了安全组和网络ACL，接下来再说说如何从本地连接到数据库。这是个很常见的需求，但仅仅限于连开发的数据库，正规一点的，从外面是无论如何也连不上生产数据库的，如果能按这标准来执行，或许能少不少删跑路的英雄事迹。但生产数据库也是有连接的需求的，一般都是用个跳板机，然后再限制连接跳板的权限，这样安全性就提高了不少。</p>
<p>回到正题，接着说从本地直接连数据库。数据库本质上就是一个或者多个EC2实例，所以在创建阶段就需要选择一个VPC，且不可更改，创建时AWS会选一个可用区，在这个区启动机器，所以，创建成功之后，VPC和子网都是确定了且不能修改的。上面说到，控制访问可以通过网络ACL和安全组，网络ACL是作用在子网级别的，修改后会影响到子网内的所有机器，这个轻易不要操作，现下就要通过修改数据库所使用的安全组了。</p>
<p>如果没有什么特殊需求，一般操作是允许网络ACL的所有进站和出站流量，也就是不限制，然后各个实例根据自己的需求修改关联的安全组。我在这里的操作就是如此，创建一个安全组，进站流量类型限制到MySql，端口3306，IP不作限制，出站流量规则不做限制，这样就可以在本地连上数据库了，下面是测试是否可连接的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -zv &#123;mysql_host_url&#125; 3306</span><br></pre></td></tr></table></figure>

<h3 id="14-部署前端到S3"><a href="#14-部署前端到S3" class="headerlink" title="14. 部署前端到S3"></a>14. 部署前端到S3</h3><p>所谓部署前端，其实就是将打包好的网页App存储到一个可供用户访问的网络位置。网页App包以其中的index.html作为入口，同时还包含需要的所有资源，如js文件、图片资源、样式文件、字体文件，等等。S3可为存储桶中的文件提供一个可公开访问的URL，这样就可以将App包上传到存储桶，将存储桶公开，通过index.html的URL即可访问。当然，这些仅限于静态网页，毕竟存储桶是个存储设备，若要做动态网页需要考虑其他方案。</p>
<p>存储桶支持动态网页部署的功能，可设置入口文件和错误文件，默认做法是将这两个选项都设置成index.html，因为有些请求内会返回非200，这个时候也是需要访问index.html，所以都设置成一样的即可。</p>
<h3 id="15-关于跨域"><a href="#15-关于跨域" class="headerlink" title="15. 关于跨域"></a>15. 关于跨域</h3><p>当一个URL地址为<code>https://www.aaa.com</code>网页中，向<code>https://www.bbb.com</code>发起了一个请求，这个时候就发生了跨域操作，不仅如此，当protocol、host和port中，任何一个不同时，都是跨域操作，CORS（Corss Origin Resources Sharing），这样的请求会被浏览器拦截，是发送不出去的。但是，如果通过命令行或是其他Http客户端，如PostMan之类，你会发现一切都是正常的，所以，可以明确的是，跨域这个策略policy是浏览器的行为，而不是<code>https://www.bbb.com</code>的拒绝提供服务。</p>
<p>在浏览器看来，他觉得既然你这个网页是来自a，你却向b发出请求，那么这个行为就是有安全风险的，所以要禁止。比如百度搜索的网页上搜索一个东西，百度拿到搜索关键词之后什么都不干，扭头就调用谷歌的接口，把谷歌返回的结果展示个用户，结果广告费都让百度赚了，活却都是谷歌干的。当然这只是一个不太恰当但却能说明事情的小栗子。</p>
<p>但是，这种跨域请求却是一个比较常见的场景，尤其是在前后端分离的架构中，前端网页部署在S3上，访问网页肯定是S3的URL地址，而服务器部署在API Gateway，向服务器发请求时肯定是Gateway提供的URL，这两个URL是不一样的。还有一些场景，如在网页上调用一些三方的服务接口，如统计、广告等，都会出现跨域的操作。</p>
<p>解决跨域问题有两种方式，很显然，一个是在前端网页处理，另个是在后端服务器处理。</p>
<p>前端网页处理时，就要设置一个代理，通过代理去访问服务器，以此来通过浏览器的检查。而后端服务器的处理方式则是告诉浏览器：嘿，你别拦截了，我允许他访问我，我们俩是一伙的。具体方式就是，在发起请求前，先向服务器发送一个OPTIONS请求，服务器把允许的Origin、Headers和Method都返回来，浏览器按照服务器提供的白名单做出检查，如果都符合则放行，否则拦截。Origin表示允许谁访问，Headers表示允许的访问头，Method则表示允许的请求方式，返回<code>*</code>则表示允许任何人访问。</p>
<p>这三个字段对应三个请求头：<code>Access-Control-Allow-Origin</code>，<code>Access-Control-Allow-Headers</code>，<code>Access-Control-Allow-Methods</code>，不仅是OPTIONS请求，在服务器返回的所有回应中，都需要带着这三个header。</p>
<p>而通过在API Gateway中通过Lambda代理集成将请求转发至Lambda时，是不能修改集成响应的，这也就意味着不能载方法响应中添加header（注意区分集成响应和方法响应），AWS文档给出的解决方案是，在Lambda中手动添加，也就是在代码里添加这三个header。</p>
<h3 id="16-CloudFront"><a href="#16-CloudFront" class="headerlink" title="16. CloudFront"></a>16. CloudFront</h3><p>这个是AWS提供的一种CDN服务，如果前端网页的用户较为分散，在多个全球的多个区，可通过CDN为访问加速。先创建一个CDN分发，然后将源配置到S3的存储桶上，这里要注意权限问题，部署之后，用户就可以通过CDN提供的URL地址访问前端网页了，首次访问时CDN会从S3请求资源，并缓存，后面再有该地区的请求时，就会直接返回CDN的缓存来提高速度。这里有个问题，据说某些地区无法访问到CloudFront，不知是真是假，如果是真的，不知道AWS解决了没。</p>
<p>还要再提一句收费的问题，S3是按照存储和传输收费的，而CloudFront是按照传输收费的，定价里写是这么写的，但是月底看账单时，总能发现一些小惊喜，给这平淡无奇的生活增添一点小惊喜。如果数据量小，访问S3和访问CloudFront的成本区别应是不大。</p>
<h3 id="17-总结"><a href="#17-总结" class="headerlink" title="17. 总结"></a>17. 总结</h3><p>虽然表明上看只需要Lambda和API Gateway，但实际上里里外外用了很多服务，比如CloudWatch、RDS、SES、CloudFormation、VPC、S3、IAM、CloufFront等。但多数内容都是一次性的，也就是在初始化时配置一次，然后就不需要再管了，后面只需要关系自己的业务逻辑即可，相对来说还是比较省心。</p>

    </div>

    
    
    
    <div>
       
       <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">------------- (完) -------------</div>
    
</div>
       
      </div>
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpeg" alt="oynix 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpeg" alt="oynix 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>oynix
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://oynix.com/2022/07/b3dc6ccd3531/" title="AWS Lambda + API Gateway 搭建全流程">https://oynix.com/2022/07/b3dc6ccd3531/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/AWS/" rel="tag"># AWS</a>
              <a href="/tags/Lambda/" rel="tag"># Lambda</a>
              <a href="/tags/API-Gateway/" rel="tag"># API Gateway</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/59bdca15c1ab/" rel="prev" title="网络是怎样连接的">
      <i class="fa fa-chevron-left"></i> 网络是怎样连接的
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/07/06840e78224e/" rel="next" title="Linux配置Android打包环境">
      Linux配置Android打包环境 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%BC%95%E8%A8%80"><span class="nav-text">1. 引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Lambda%E7%BC%96%E5%86%99%E5%92%8C%E9%83%A8%E7%BD%B2"><span class="nav-text">2. Lambda编写和部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%99%84%E5%8A%A0%EF%BC%9A%E5%8E%8B%E7%BC%A9%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="nav-text">3. 附加：压缩可执行文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%99%84%E5%8A%A0%EF%BC%9A%E8%A7%92%E8%89%B2%E5%92%8C%E7%AD%96%E7%95%A5"><span class="nav-text">4. 附加：角色和策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-API-Gateway"><span class="nav-text">5. API Gateway</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-API-Gateway%E8%BD%AC%E5%8F%91%E8%87%B3Lambda"><span class="nav-text">6. API Gateway转发至Lambda</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-API-Gateway%E8%BD%AC%E5%8F%91%E8%87%B3S3"><span class="nav-text">7. API Gateway转发至S3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-API-Gateway%E6%8E%88%E6%9D%83%E6%96%B9%E9%85%8D%E7%BD%AE"><span class="nav-text">8. API Gateway授权方配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-SES"><span class="nav-text">9. SES</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-RDS"><span class="nav-text">10. RDS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-VPC%E5%92%8C%E5%AD%90%E7%BD%91"><span class="nav-text">11. VPC和子网</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-%E5%AE%89%E5%85%A8%E7%BB%84%E5%92%8C%E7%BD%91%E7%BB%9CACL"><span class="nav-text">12. 安全组和网络ACL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E6%9C%AC%E5%9C%B0%E8%BF%9E%E6%8E%A5RDS"><span class="nav-text">13. 本地连接RDS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E5%88%B0S3"><span class="nav-text">14. 部署前端到S3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-%E5%85%B3%E4%BA%8E%E8%B7%A8%E5%9F%9F"><span class="nav-text">15. 关于跨域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-CloudFront"><span class="nav-text">16. CloudFront</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-%E6%80%BB%E7%BB%93"><span class="nav-text">17. 总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oynix"
      src="/images/p.png">
  <p class="site-author-name" itemprop="name">oynix</p>
  <div class="site-description" itemprop="description">避免没有计划的行动</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">173</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">119</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL295bml4" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oynix"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOm95bml4QGZveG1haWwuY29t" title="E-Mail → mailto:oynix@foxmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fas fa-basketball-ball"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oynix</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">573k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:41</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> 强力驱动
  </div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '70fea9109cf120e422df',
      clientSecret: 'f988e3db3d5c32bf420ceff04fa7de68ce924020',
      repo        : 'oynix.github.io',
      owner       : 'oynix',
      admin       : ['oynix'],
      id          : '17d6f0a633000a8a83c9245225f5853b',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
