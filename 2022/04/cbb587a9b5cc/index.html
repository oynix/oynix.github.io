<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"oynix.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"manual"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gittabl","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="之前有提到，最近因需求特殊，所以需要把代码藏起来，想着想着就盯上了资源图。为了把代码藏到png里，所以专门研究了png的文件格式。">
<meta property="og:type" content="article">
<meta property="og:title" content="把代码藏到png里">
<meta property="og:url" content="https://oynix.github.io/2022/04/cbb587a9b5cc/index.html">
<meta property="og:site_name" content="oynix">
<meta property="og:description" content="之前有提到，最近因需求特殊，所以需要把代码藏起来，想着想着就盯上了资源图。为了把代码藏到png里，所以专门研究了png的文件格式。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-04T03:21:50.000Z">
<meta property="article:modified_time" content="2022-04-07T07:00:42.455Z">
<meta property="article:author" content="oynix">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://oynix.github.io/2022/04/cbb587a9b5cc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>把代码藏到png里 | oynix</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDBNTK34GB"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDBNTK34GB');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">oynix</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">人生需要一些摸鱼时刻，做什么都可以，不做什么也可以</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">86</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">25</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">109</span></a>

  </li>
        <li class="menu-item menu-item-message">

    <a href="/message/" rel="section"><i class="fas fa-envelope-open-text fa-fw"></i>留言板</a>

  </li>
        <li class="menu-item menu-item-articles">

    <a href="/articles/" rel="section"><i class="fa fa-blog fa-fw"></i>技术博客</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL295bml4" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://oynix.github.io/2022/04/cbb587a9b5cc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/fbb.jpg">
      <meta itemprop="name" content="oynix">
      <meta itemprop="description" content="避免没有计划的行动">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="oynix">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          把代码藏到png里
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-04 11:21:50" itemprop="dateCreated datePublished" datetime="2022-04-04T11:21:50+08:00">2022-04-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前有提到，最近因需求特殊，所以需要把代码藏起来，想着想着就盯上了资源图。为了把代码藏到png里，所以专门研究了png的文件格式。</p>
<span id="more"></span>
<p>宏观来看，文件都是以字节为单位存储在介质上，如电脑硬盘，手机ROM，而字节无非就是010101的形式，那么既然都是010101的格式，为什么有的文件是png，有的文件是jpg，还有的文件是webp呢？这里面，一定有着什么规则，就像是网络里的各种协议，是同样的道理。</p>
<p>要查看这些，首先就要把文件以二进制的形式打开，我用的是UltraEdit，也可以用其他的。</p>
<h3 id="1-png文件结构"><a href="#1-png文件结构" class="headerlink" title="1. png文件结构"></a>1. png文件结构</h3><p>关于png文件结构，白皮书有着详细介绍，<span class="exturl" data-url="aHR0cHM6Ly93d3cudzMub3JnL1RSL1BORy8=">这里是官方文档<i class="fa fa-external-link-alt"></i></span>。这个文档里面对png进行了十分详尽的介绍。总的来说，png文件的结构就是一个文件头，加上若干了chunk块组成，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[文件头][chunk][chunk][chunk][chunk][chunk]</span><br></pre></td></tr></table></figure>

<h3 id="2-文件头"><a href="#2-文件头" class="headerlink" title="2. 文件头"></a>2. 文件头</h3><p>正如白皮书中所说，png文件头是固定的</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">89 </span><span class="number">50</span> <span class="number">4</span>E <span class="number">47</span> <span class="number">0</span>D <span class="number">0</span>A <span class="number">1</span>A <span class="number">0</span>A</span><br></pre></td></tr></table></figure>
<p>这是16进制格式，每个数字代表4个bit，所以每两个数字代表一个byte，文件头的长度是8个字节。第一个字节0x89是规定的，用一个超过ASCII字符范围的值，为的就是防止被当作文本文件处理。紧接着的3个字节，查一下ASCII表就知道了，50=P，4E=N，47=G，剩下的0D 0A 1A 0A是什么没说，文档上就一句话，这个签名表明是png图片</p>
<blockquote>
<p>5.2 PNG signature<br>The first eight bytes of a PNG datastream always contain the following (decimal) values:</p>
<p>  137 80 78 71 13 10 26 10<br>This signature indicates that the remainder of the datastream contains a single PNG image, consisting of a series of chunks beginning with an IHDR chunk and ending with an IEND chunk.</p>
</blockquote>
<h3 id="3-chunk结构"><a href="#3-chunk结构" class="headerlink" title="3. chunk结构"></a>3. chunk结构</h3><p>结构如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[LENGTH][CHUNK TYPE][CHUNK DATA][CRC]</span><br></pre></td></tr></table></figure>
<p>当chunk data的长度是0时，chunk的结构是这样的，就是去掉了DATA部分</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[LENGTH][CHUNK TYPE][CRC]</span><br></pre></td></tr></table></figure>
<p>其中，LENGHT的长度是4个字节，TYPE的长度也是4个字节，DATA的长度对于不同的TYPE是不同的，LENGTH的值就是DATA的长度，CRC的长度也是4个字节，下面一一自报家门。</p>
<h3 id="4-chunk-type"><a href="#4-chunk-type" class="headerlink" title="4. chunk type"></a>4. chunk type</h3><p>type表明了chunk块的类型，目前png一共定义了18个类型，然后又把这18个类型分为两大种，一个是关键chunks，另个是辅助chunks。关键chunks一共有4个，剩下的都是辅助类型，有些类型的位置是固定的，这些都写在白皮书的5.6小节。</p>
<p>关键chunks，</p>
<table>
<thead>
<tr>
<th>chunk name</th>
<th>multiple allowed</th>
<th>optinal</th>
<th>order constraint</th>
</tr>
</thead>
<tbody><tr>
<td>IHDR</td>
<td>No</td>
<td>No</td>
<td>Shall be first</td>
</tr>
<tr>
<td>PLTE</td>
<td>No</td>
<td>Yes</td>
<td>Before first IDAT</td>
</tr>
<tr>
<td>IDAT</td>
<td>Yes</td>
<td>No</td>
<td>Multiple IDAT chunks shall be consecutive</td>
</tr>
<tr>
<td>IEND</td>
<td>No</td>
<td>No</td>
<td>Shall be last</td>
</tr>
</tbody></table>
<p>辅助chunks，所有辅助chunk都是可选的，意思即使png文件里可能有也可能没有</p>
<table>
<thead>
<tr>
<th>chunk name</th>
<th>multiple allowed</th>
<th>order constraint</th>
</tr>
</thead>
<tbody><tr>
<td>cHRM</td>
<td>No</td>
<td>Before PLTE and IDAT</td>
</tr>
<tr>
<td>gAMA</td>
<td>No</td>
<td>Before PLTE and IDAT</td>
</tr>
<tr>
<td>iCCP</td>
<td>No</td>
<td>Before PLTE and IDAT. If the iCCP chunk is present, the sRGB chunk should not be present.</td>
</tr>
<tr>
<td>sBIT</td>
<td>No</td>
<td>Before PLTE and IDAT</td>
</tr>
<tr>
<td>sRGB</td>
<td>No</td>
<td>Before PLTE and IDAT. If the sRGB chunk is present, the iCCP chunk should not be present.</td>
</tr>
<tr>
<td>bKGD</td>
<td>No</td>
<td>After PLTE; before IDAT</td>
</tr>
<tr>
<td>hIST</td>
<td>No</td>
<td>After PLTE; before IDAT</td>
</tr>
<tr>
<td>tRNS</td>
<td>No</td>
<td>After PLTE; before IDAT</td>
</tr>
<tr>
<td>pHYs</td>
<td>No</td>
<td>Before IDAT</td>
</tr>
<tr>
<td>sPLT</td>
<td>Yes</td>
<td>Before IDAT</td>
</tr>
<tr>
<td>tIME</td>
<td>No</td>
<td>None</td>
</tr>
<tr>
<td>iTXt</td>
<td>Yes</td>
<td>None</td>
</tr>
<tr>
<td>tEXt</td>
<td>Yes</td>
<td>None</td>
</tr>
<tr>
<td>zTXt</td>
<td>Yes</td>
<td>None</td>
</tr>
</tbody></table>
<h3 id="5-chunk-data"><a href="#5-chunk-data" class="headerlink" title="5. chunk data"></a>5. chunk data</h3><p>chunk的数据都存放在data里，data的长度，也就是字节数量，等于LENGTH的值。</p>
<h3 id="6-chunk-crc"><a href="#6-chunk-crc" class="headerlink" title="6. chunk crc"></a>6. chunk crc</h3><p>crc存放的是该chunk块的校验码，采用的是crc32的计算方式，将type和data输入，输出的结果就是crc</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk crc = crc32([CHUNK <span class="keyword">TYPE</span>][CHUNK <span class="keyword">DATA</span>])</span><br></pre></td></tr></table></figure>
<p>白皮书里是这么介绍的，另外<span class="exturl" data-url="aHR0cDovL3d3dy5saWJwbmcub3JnL3B1Yi9wbmcvc3BlYy8xLjIvUE5HLVN0cnVjdHVyZS5odG1sI0NSQy1hbGdvcml0aG0=">这个文档里有介绍png所使用的crc算法<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.5</span> Cyclic Redundancy Code algorithm</span><br><span class="line">CRC fields are calculated <span class="keyword">using</span> standardized CRC methods <span class="keyword">with</span> pre <span class="built_in">and</span> post conditioning, <span class="keyword">as</span> defined <span class="keyword">by</span> ISO <span class="number">3309</span> [ISO-<span class="number">3309</span>] <span class="built_in">and</span> ITU-T V.<span class="number">42</span> [ITU-T-V42]. The CRC polynomial employed <span class="built_in">is</span></span><br><span class="line"></span><br><span class="line">x32 + x26 + x23 + x22 + x16 + x12 + x11 + x10 + x8 + x7 + x5 + x4 + x2 + x + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> PNG, the <span class="number">32</span>-bit CRC <span class="built_in">is</span> initialized <span class="keyword">to</span> all <span class="number">1</span><span class="comment">&#x27;s, and then the data from each byte is processed from the least significant bit (1) to the most significant bit (128). After all the data bytes are processed, the CRC is inverted (its ones complement is taken). This value is transmitted (stored in the datastream) MSB first. For the purpose of separating into bytes and ordering, the least significant bit of the 32-bit CRC is defined to be the coefficient of the x31 term.</span></span><br><span class="line"></span><br><span class="line">Practical calculation <span class="keyword">of</span> the CRC often employs a precalculated table <span class="keyword">to</span> accelerate the computation. See Annex D: Sample Cyclic Redundancy Code implementation.</span><br></pre></td></tr></table></figure>
<p>看完了计算原理之后，便开始自己实现算法，写着写着发现python有现成的lib提供crc32的算法，带入了几组数据之后发现，结果竟然都正确，既然如此，那我还吭哧吭哧的实现什么呢。</p>
<h3 id="7-关键chunk块，IHDR"><a href="#7-关键chunk块，IHDR" class="headerlink" title="7. 关键chunk块，IHDR"></a>7. 关键chunk块，IHDR</h3><p>IHDR块一般都紧跟在文件头那8个字节后面，其中chunk data部分每个字节存储的数据表示的含义都是固定的，如下</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Bytes Length</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>width</td>
<td>4 bytes</td>
<td>宽度，单位像素</td>
</tr>
<tr>
<td>height</td>
<td>4 bytes</td>
<td>高度，单位像素</td>
</tr>
<tr>
<td>bit depth</td>
<td>1 byte</td>
<td>图像深度</td>
</tr>
<tr>
<td>color type</td>
<td>1 byte</td>
<td>颜色类型</td>
</tr>
<tr>
<td>compression method</td>
<td>1 byte</td>
<td>压缩方法</td>
</tr>
<tr>
<td>filter metho</td>
<td>1 byte</td>
<td>滤波器方法</td>
</tr>
<tr>
<td>interlace method</td>
<td>1 byte</td>
<td>隔行扫描</td>
</tr>
</tbody></table>
<p>我找了个一个png图片的前几个字节，一起对着来看看</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">89 </span><span class="number">50</span> <span class="number">4</span>E <span class="number">47</span> <span class="number">0</span>D <span class="number">0</span>A <span class="number">1</span>A <span class="number">0</span>A </span><br><span class="line"><span class="symbol">00 </span><span class="number">00</span> <span class="number">00</span> <span class="number">0</span>D </span><br><span class="line"><span class="symbol">49 </span><span class="number">48</span> <span class="number">44</span> <span class="number">52</span> </span><br><span class="line"><span class="symbol">00 </span><span class="number">00</span> <span class="number">02</span> D0 <span class="number">00</span> <span class="number">00</span> <span class="number">05</span> <span class="number">00</span> <span class="number">08</span> <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line"><span class="number">6</span>E CE <span class="number">65</span> <span class="number">3</span>D</span><br></pre></td></tr></table></figure>
<p>为了便于观察，我给它断成了几行，第一行就不用多说了，是png文件头，后面的都是IHDR chunk块。前4个字节00 00 00 0D代表着chunk length，计算出来是13，接下来的个4个字节，就是ASCII码，49=I，48=H，44=D，52=R。然后就是最长的一行，数一数可以发现，正好是13个byte，和chunk length的值是一致的，根据上表可知，00 00 02 D0为图片宽度，算出来是720像素，00 00 05 00是高度1280像素，后面的图像深度、颜色类型什么的，就不看了，直接看chunk crc部分的6E CE 65 3D，计算一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data = [<span class="number">0x49</span>, <span class="number">0x48</span>, <span class="number">0x44</span>, <span class="number">0x52</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0xD0</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>]</span><br><span class="line">    crc = zlib.crc32(<span class="built_in">bytearray</span>(data))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(crc))</span><br></pre></td></tr></table></figure>
<p>运行结果：0x6ece653d。可见，截止至此，一切看起来都是正常的。</p>
<h3 id="7-关键chunk块，IDAT、IEND"><a href="#7-关键chunk块，IDAT、IEND" class="headerlink" title="7. 关键chunk块，IDAT、IEND"></a>7. 关键chunk块，IDAT、IEND</h3><p>这两个的chunk块和IHDR是一样的，如果能明白上面的IHDR，这两个就也能明白。这里单独说一句IEND，因为这个chunk块没有chunk data部分，所以，所有png的IEND块都是一样的，一样的length，一样的type，以及一样的crc。</p>
<h3 id="8-插入代码"><a href="#8-插入代码" class="headerlink" title="8. 插入代码"></a>8. 插入代码</h3><p>好了，有了上面的基础知识准备，开始干点正事。</p>
<p>png中，像素的数据存在连续的IDAT chunk中，一长串的IDAT数据，根据IHDR中width和height参数，再解析出来。</p>
<p>我开始的想法，是把代码藏在辅助chunk中，那么多可选的辅助类型，照片的地理位置、镜头、光圈等信息，都是存放在这些辅助chunk里，随便选几个，把数据插入到data部分，然后再计算一下crc不就完美了吗？冷静下来后，觉得此法尚有不妥之处，你想啊，一个png图片，辅助信息占了好大一个比例，但是这个辅助信息又不是正常的文本，或是数字，除了自己知道怎么解析，别人都看不懂，让人易生疑心：你这里面是不是藏了什么不能见人的东西？这浑身是嘴也说不清楚。</p>
<p>有个同事是把代码直接拼在了文件的末尾，因为width和height没变，中间的IDAT也没变，所以完全不影响png文件的读取，遇到IEDN就停了，即便你后面还有数据也不妨事。当代码很少时，难以看出端倪，但是代码一旦很多，画风就会很诡异：一个几十像素乘几十像素的图片，文件大小却足足有上百kB，这就好比，你E盘存储进度条都变红了，点进去一看，发现里面只有一集蜡笔小新的动画，还是渣画质，大小为20MB，你可以说这里一切正常，但要是有人信了，就当你没说。这个时候，只要一打开png文件，就会看到后面跟着的那条长长的尾巴。</p>
<p>思索再三，我还是决定把代码伪装成IDAT块，插入到最后一个IDAT和IEND之间，且，如果代码很大，就切成片段，插入到多个png图片中，以保证起码看上去显得很和谐。比如IHDR中width是720，height是1280，所以IDAT中，只有720x1280=921,600个像素会被显示出来，后面的IDAT是不会影响png解析的。但是为了以防万一，在插入之前，是需要把代码加密的，一般是和一个数字做异或操作，等到解析时，从png中取出代码，再与同一个数字做异或操作即可，这样一来，即便是被一些小机灵鬼发现端倪，找到隐藏的秘密，也不至于造成代码泄漏。</p>
<p>除此之外，还有一些简单的方式，比如直接把代码的.jar改成.ttf，伪装成字体文件，放在项目中，我觉得这种方式就是在靠天吃饭，看命，但凡遇到个勤劳的人，就会发现这个ttf并不简单，再顺着这个ttf找引用，顺藤摸瓜，就让人抄了老巢。</p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>最新发现，在开启了minifyEnabled后，drawable里的图片会被压缩，这个事是aapt在做，根绝结果来看，它是根据png IHDR里的长和宽计算出数据的总长度，然后把超出的IDAT切掉。如果不想被无情阉割，那么就要修改IHDR里的长和宽，让额外的IDAT成为png的一部分，但是这样的问题是，无法正常解析出额外的部分的像素值，折衷的策略是，找一个View引用这张图，但是这个View永远不会显示。还有个退而求其次的方式，那就是放到raw目录中，这个目录下的图片不会被阉割，都是完整的。</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZXNlc3R0L2FyY2hpdmUvMjAwNy8wOC8wOS84NDg4NTYuaHRtbA==">https://www.cnblogs.com/esestt/archive/2007/08/09/848856.html<i class="fa fa-external-link-alt"></i></span><br>一个介绍crc算法原理的文章，写的非常详细，才看了一遍我就看明白了，虽然也没算出来，但我觉得这和文章没有关系，一定是我的问题，遇到问题要多反思自己。</p>
<p>最后，再推荐一个网站，用来压缩png图片，无损或接近无损，<span class="exturl" data-url="aHR0cHM6Ly90aW55cG5nLmNvbS8=">TinyPng<i class="fa fa-external-link-alt"></i></span>。但是，每次上传下载效率很差，所以有不愿透露姓名的热心市民写了一个客户端，效率指数加倍，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2t5bGVkdW8vVGlueVBORzRNYWM=">在这里<i class="fa fa-external-link-alt"></i></span>。</p>

    </div>

    
    
    
    <div>
       
       <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">------------- (完) -------------</div>
    
</div>
       
      </div>
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpeg" alt="oynix 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpeg" alt="oynix 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>oynix
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://oynix.github.io/2022/04/cbb587a9b5cc/" title="把代码藏到png里">https://oynix.github.io/2022/04/cbb587a9b5cc/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"># Python</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/f58f06543ab2/" rel="prev" title="AndroidStudio logcat过滤器">
      <i class="fa fa-chevron-left"></i> AndroidStudio logcat过滤器
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/67fb7c494fc5/" rel="next" title="c/c++指针与数组">
      c/c++指针与数组 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-png%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-text">1. png文件结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="nav-text">2. 文件头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-chunk%E7%BB%93%E6%9E%84"><span class="nav-text">3. chunk结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-chunk-type"><span class="nav-text">4. chunk type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-chunk-data"><span class="nav-text">5. chunk data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-chunk-crc"><span class="nav-text">6. chunk crc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%85%B3%E9%94%AEchunk%E5%9D%97%EF%BC%8CIHDR"><span class="nav-text">7. 关键chunk块，IHDR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%85%B3%E9%94%AEchunk%E5%9D%97%EF%BC%8CIDAT%E3%80%81IEND"><span class="nav-text">7. 关键chunk块，IDAT、IEND</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E6%8F%92%E5%85%A5%E4%BB%A3%E7%A0%81"><span class="nav-text">8. 插入代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-text">补充</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-text">附录</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oynix"
      src="/images/fbb.jpg">
  <p class="site-author-name" itemprop="name">oynix</p>
  <div class="site-description" itemprop="description">避免没有计划的行动</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">109</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">86</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL295bml4" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oynix"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOm95bml4QGZveG1haWwuY29t" title="E-Mail → mailto:oynix@foxmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fas fa-basketball-ball"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oynix</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">351k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:19</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> 强力驱动
  </div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>



  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '70fea9109cf120e422df',
      clientSecret: 'f988e3db3d5c32bf420ceff04fa7de68ce924020',
      repo        : 'oynix.github.io',
      owner       : 'oynix',
      admin       : ['oynix'],
      id          : 'b6d8ddb77a05f8134bec77f99a2b50d7',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
